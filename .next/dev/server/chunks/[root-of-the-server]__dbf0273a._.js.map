{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 48, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jerry/Desktop/PROJECT%202026/POS/src/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\nimport { Pool } from \"pg\";\r\nimport { PrismaPg } from \"@prisma/adapter-pg\";\r\n\r\nif (!process.env.DATABASE_URL) {\r\n  throw new Error(\r\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\r\n  );\r\n}\r\n\r\n// Setup connection pool and Prisma Pg Adapter\r\nconst pool = new Pool({ connectionString: process.env.DATABASE_URL });\r\nconst adapter = new PrismaPg(pool);\r\n\r\n// Prevent multiple instances of Prisma Client in development\r\ndeclare global {\r\n  var prisma: PrismaClient | undefined;\r\n}\r\n\r\nexport const prisma = global.prisma || new PrismaClient({ adapter });\r\nexport const db = prisma; // Alias to prevent breaking too many imports right away\r\n\r\nif (process.env.NODE_ENV !== \"production\") global.prisma = prisma;\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;;;;;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,MAAM,IAAI,MACR;AAEJ;AAEA,8CAA8C;AAC9C,MAAM,OAAO,IAAI,wLAAI,CAAC;IAAE,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAAC;AACnE,MAAM,UAAU,IAAI,4MAAQ,CAAC;AAOtB,MAAM,SAAS,OAAO,MAAM,IAAI,IAAI,yOAAY,CAAC;IAAE;AAAQ;AAC3D,MAAM,KAAK,QAAQ,wDAAwD;AAElF,wCAA2C,OAAO,MAAM,GAAG"}},
    {"offset": {"line": 85, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jerry/Desktop/PROJECT%202026/POS/src/lib/storage.ts"],"sourcesContent":["import {\r\n  type User,\r\n  type InsertUser,\r\n  type Product,\r\n  type InsertProduct,\r\n  type Service,\r\n  type InsertService,\r\n  type Sale,\r\n  type InsertSale,\r\n  type SaleItem,\r\n  type InsertSaleItem,\r\n  UserRoleEnum,\r\n} from \"@shared/schema\";\r\nimport { prisma } from \"./db\";\r\n\r\nexport interface IStorage {\r\n  // Users\r\n  getUsers(): Promise<any[]>;\r\n  getUser(id: string): Promise<any | undefined>;\r\n  getUserByUsername(username: string): Promise<any | undefined>;\r\n  createUser(data: any): Promise<any>;\r\n  updateUser(id: string, data: any): Promise<any | undefined>;\r\n  deleteUser(id: string): Promise<boolean>;\r\n\r\n  // Products\r\n  getProducts(): Promise<any[]>;\r\n  getProduct(id: string): Promise<any | undefined>;\r\n  getLowStockProducts(): Promise<any[]>;\r\n  createProduct(data: any): Promise<any>;\r\n  updateProduct(id: string, data: any): Promise<any | undefined>;\r\n  deleteProduct(id: string): Promise<boolean>;\r\n\r\n  // Services\r\n  getServices(): Promise<any[]>;\r\n  getService(id: string): Promise<any | undefined>;\r\n  createService(data: any): Promise<any>;\r\n  updateService(id: string, data: any): Promise<any | undefined>;\r\n  deleteService(id: string): Promise<boolean>;\r\n\r\n  // Sales\r\n  getSales(): Promise<any[]>;\r\n  getSale(id: string): Promise<any | undefined>;\r\n  getSalesByDateRange(startDate: Date, endDate: Date): Promise<any[]>;\r\n  createSale(data: any): Promise<any>;\r\n  updateSale(id: string, data: any): Promise<any | undefined>;\r\n\r\n  // Sale Items\r\n  getSaleItems(saleId: string): Promise<any[]>;\r\n  createSaleItem(data: any): Promise<any>;\r\n\r\n  // Dashboard\r\n  getDashboardStats(): Promise<any>;\r\n\r\n  // Reports\r\n  getSalesReport(period: string): Promise<any>;\r\n}\r\n\r\nexport class DatabaseStorage implements IStorage {\r\n  // Users\r\n  async getUsers() {\r\n    return prisma.user.findMany({\r\n      orderBy: { createdAt: \"desc\" },\r\n    });\r\n  }\r\n\r\n  async getUser(id: string) {\r\n    return prisma.user.findUnique({ where: { id } }) || undefined;\r\n  }\r\n\r\n  async getUserByUsername(username: string) {\r\n    return prisma.user.findUnique({ where: { username } }) || undefined;\r\n  }\r\n\r\n  async createUser(data: any) {\r\n    return prisma.user.create({ data });\r\n  }\r\n\r\n  async updateUser(id: string, data: any) {\r\n    return prisma.user.update({\r\n      where: { id },\r\n      data,\r\n    });\r\n  }\r\n\r\n  async deleteUser(id: string) {\r\n    await prisma.user.delete({ where: { id } });\r\n    return true;\r\n  }\r\n\r\n  // Products\r\n  async getProducts() {\r\n    return prisma.product.findMany({\r\n      orderBy: { createdAt: \"desc\" },\r\n    });\r\n  }\r\n\r\n  async getProduct(id: string) {\r\n    return prisma.product.findUnique({ where: { id } }) || undefined;\r\n  }\r\n\r\n  async getLowStockProducts() {\r\n    // raw query syntax simulation or advanced findMany\r\n    const products = await prisma.product.findMany({\r\n      where: {\r\n        isActive: true,\r\n      }\r\n    });\r\n    return products.filter(p => p.stockQuantity <= p.lowStockThreshold);\r\n  }\r\n\r\n  async createProduct(data: any) {\r\n    return prisma.product.create({ data });\r\n  }\r\n\r\n  async updateProduct(id: string, data: any) {\r\n    return prisma.product.update({\r\n      where: { id },\r\n      data,\r\n    });\r\n  }\r\n\r\n  async deleteProduct(id: string) {\r\n    await prisma.product.delete({ where: { id } });\r\n    return true;\r\n  }\r\n\r\n  // Services\r\n  async getServices() {\r\n    return prisma.service.findMany({\r\n      orderBy: { createdAt: \"desc\" },\r\n    });\r\n  }\r\n\r\n  async getService(id: string) {\r\n    return prisma.service.findUnique({ where: { id } }) || undefined;\r\n  }\r\n\r\n  async createService(data: any) {\r\n    return prisma.service.create({ data });\r\n  }\r\n\r\n  async updateService(id: string, data: any) {\r\n    return prisma.service.update({\r\n      where: { id },\r\n      data,\r\n    });\r\n  }\r\n\r\n  async deleteService(id: string) {\r\n    await prisma.service.delete({ where: { id } });\r\n    return true;\r\n  }\r\n\r\n  // Sales\r\n  async getSales() {\r\n    return prisma.sale.findMany({\r\n      orderBy: { createdAt: \"desc\" },\r\n    });\r\n  }\r\n\r\n  async getSale(id: string) {\r\n    return prisma.sale.findUnique({ where: { id } }) || undefined;\r\n  }\r\n\r\n  async getSalesByDateRange(startDate: Date, endDate: Date) {\r\n    return prisma.sale.findMany({\r\n      where: {\r\n        createdAt: {\r\n          gte: startDate,\r\n          lte: endDate,\r\n        },\r\n      },\r\n      orderBy: { createdAt: \"desc\" },\r\n    });\r\n  }\r\n\r\n  async createSale(data: any) {\r\n    return prisma.sale.create({ data });\r\n  }\r\n\r\n  async updateSale(id: string, data: any) {\r\n    return prisma.sale.update({\r\n      where: { id },\r\n      data,\r\n    });\r\n  }\r\n\r\n  // Sale Items\r\n  async getSaleItems(saleId: string) {\r\n    return prisma.saleItem.findMany({\r\n      where: { saleId },\r\n    });\r\n  }\r\n\r\n  async createSaleItem(data: any) {\r\n    return prisma.saleItem.create({ data });\r\n  }\r\n\r\n  // Dashboard\r\n  async getDashboardStats() {\r\n    const today = new Date();\r\n    today.setHours(0, 0, 0, 0);\r\n    const tomorrow = new Date(today);\r\n    tomorrow.setDate(tomorrow.getDate() + 1);\r\n\r\n    const todaySalesData = await prisma.sale.findMany({\r\n      where: {\r\n        createdAt: {\r\n          gte: today,\r\n          lt: tomorrow,\r\n        },\r\n      },\r\n    });\r\n\r\n    const todaySales = todaySalesData.length;\r\n    const todayRevenue = todaySalesData.reduce(\r\n      (sum: number, s: any) => sum + Number(s.total),\r\n      0\r\n    );\r\n\r\n    const totalProducts = await prisma.product.count();\r\n    const totalServices = await prisma.service.count();\r\n\r\n    const lowStockCount = (await this.getLowStockProducts()).length;\r\n\r\n    const recentSales = await prisma.sale.findMany({\r\n      orderBy: { createdAt: \"desc\" },\r\n      take: 5,\r\n    });\r\n\r\n    const weekStart = new Date(today);\r\n    weekStart.setDate(weekStart.getDate() - 6);\r\n\r\n    const weeklySalesData = await prisma.sale.findMany({\r\n      where: {\r\n        createdAt: {\r\n          gte: weekStart,\r\n        },\r\n      },\r\n    });\r\n\r\n    const weeklySales: { day: string; total: number }[] = [];\r\n    for (let i = 6; i >= 0; i--) {\r\n      const date = new Date(today);\r\n      date.setDate(date.getDate() - i);\r\n      const dayName = date.toLocaleDateString(\"en-US\", { weekday: \"short\" });\r\n      const dayStart = new Date(date);\r\n      dayStart.setHours(0, 0, 0, 0);\r\n      const dayEnd = new Date(date);\r\n      dayEnd.setHours(23, 59, 59, 999);\r\n\r\n      const dayTotal = weeklySalesData\r\n        .filter((s: any) => {\r\n          const saleDate = new Date(s.createdAt);\r\n          return saleDate >= dayStart && saleDate <= dayEnd;\r\n        })\r\n        .reduce((sum: number, s: any) => sum + Number(s.total), 0);\r\n\r\n      weeklySales.push({ day: dayName, total: dayTotal });\r\n    }\r\n\r\n    return {\r\n      todaySales,\r\n      todayRevenue,\r\n      totalProducts,\r\n      totalServices,\r\n      lowStockCount,\r\n      recentSales,\r\n      weeklySales,\r\n    };\r\n  }\r\n\r\n  // Reports\r\n  async getSalesReport(period: string) {\r\n    const now = new Date();\r\n    let startDate: Date;\r\n\r\n    switch (period) {\r\n      case \"today\":\r\n        startDate = new Date(now);\r\n        startDate.setHours(0, 0, 0, 0);\r\n        break;\r\n      case \"week\":\r\n        startDate = new Date(now);\r\n        startDate.setDate(startDate.getDate() - 7);\r\n        break;\r\n      case \"month\":\r\n        startDate = new Date(now);\r\n        startDate.setMonth(startDate.getMonth() - 1);\r\n        break;\r\n      case \"year\":\r\n        startDate = new Date(now);\r\n        startDate.setFullYear(startDate.getFullYear() - 1);\r\n        break;\r\n      default:\r\n        startDate = new Date(now);\r\n        startDate.setDate(startDate.getDate() - 7);\r\n    }\r\n\r\n    const salesData = await prisma.sale.findMany({\r\n      where: {\r\n        createdAt: {\r\n          gte: startDate,\r\n        },\r\n      },\r\n      orderBy: { createdAt: \"desc\" },\r\n      include: {\r\n        items: true,\r\n      }\r\n    });\r\n\r\n    const totalSales = salesData.length;\r\n    const totalRevenue = salesData.reduce(\r\n      (sum: number, s: any) => sum + Number(s.total),\r\n      0\r\n    );\r\n    const averageOrderValue = totalSales > 0 ? totalRevenue / totalSales : 0;\r\n\r\n    const allSaleItems = salesData.flatMap(s => s.items);\r\n\r\n    // Sales by day\r\n    const salesByDayMap = new Map<string, { total: number; count: number }>();\r\n    for (const sale of salesData) {\r\n      const date = new Date(sale.createdAt).toLocaleDateString(\"en-US\", {\r\n        month: \"short\",\r\n        day: \"numeric\",\r\n      });\r\n      const existing = salesByDayMap.get(date) || { total: 0, count: 0 };\r\n      salesByDayMap.set(date, {\r\n        total: existing.total + Number(sale.total),\r\n        count: existing.count + 1,\r\n      });\r\n    }\r\n    const salesByDay = Array.from(salesByDayMap.entries()).map(\r\n      ([date, data]) => ({\r\n        date,\r\n        total: data.total,\r\n        count: data.count,\r\n      })\r\n    );\r\n\r\n    // Sales by category\r\n    const salesByCategory: { category: string; total: number; count: number }[] = [\r\n      { category: \"networking\", total: 0, count: 0 },\r\n      { category: \"cctv\", total: 0, count: 0 },\r\n      { category: \"intercom\", total: 0, count: 0 },\r\n      { category: \"services\", total: 0, count: 0 },\r\n    ];\r\n\r\n    for (const item of allSaleItems) {\r\n      if (item.productId) {\r\n        const product = await this.getProduct(item.productId);\r\n        if (product) {\r\n          const cat = salesByCategory.find((c) => c.category === product.category);\r\n          if (cat) {\r\n            cat.total += Number(item.total);\r\n            cat.count += item.quantity;\r\n          }\r\n        }\r\n      } else if (item.serviceId) {\r\n        const cat = salesByCategory.find((c) => c.category === \"services\");\r\n        if (cat) {\r\n          cat.total += Number(item.total);\r\n          cat.count += item.quantity;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Top products\r\n    const productSales = new Map<string, { quantity: number; revenue: number }>();\r\n    for (const item of allSaleItems) {\r\n      const existing = productSales.get(item.name) || { quantity: 0, revenue: 0 };\r\n      productSales.set(item.name, {\r\n        quantity: existing.quantity + item.quantity,\r\n        revenue: existing.revenue + Number(item.total),\r\n      });\r\n    }\r\n    const topProducts = Array.from(productSales.entries())\r\n      .map(([name, data]) => ({\r\n        name,\r\n        quantity: data.quantity,\r\n        revenue: data.revenue,\r\n      }))\r\n      .sort((a, b) => b.revenue - a.revenue)\r\n      .slice(0, 10);\r\n\r\n    return {\r\n      totalSales,\r\n      totalRevenue,\r\n      averageOrderValue,\r\n      salesByDay,\r\n      salesByCategory: salesByCategory.filter((c) => c.total > 0),\r\n      topProducts,\r\n      recentSales: salesData.slice(0, 20),\r\n    };\r\n  }\r\n}\r\n\r\nexport const storage = new DatabaseStorage();\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 510, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jerry/Desktop/PROJECT%202026/POS/src/lib/auth.ts"],"sourcesContent":["import { jwtVerify, SignJWT } from \"jose\";\r\nimport { cookies } from \"next/headers\";\r\nimport { User } from \"@shared/schema\";\r\nimport { storage } from \"./storage\";\r\nimport { scrypt, randomBytes, timingSafeEqual } from \"crypto\";\r\nimport { promisify } from \"util\";\r\n\r\n// --- JWT Setup ---\r\nconst secretKey = process.env.SESSION_SECRET || \"fallback_secret_key_for_development\";\r\nconst key = new TextEncoder().encode(secretKey);\r\n\r\nexport async function encrypt(payload: any) {\r\n    return await new SignJWT(payload)\r\n        .setProtectedHeader({ alg: \"HS256\" })\r\n        .setIssuedAt()\r\n        .setExpirationTime(\"24h\")\r\n        .sign(key);\r\n}\r\n\r\nexport async function decrypt(input: string): Promise<any> {\r\n    try {\r\n        const { payload } = await jwtVerify(input, key, {\r\n            algorithms: [\"HS256\"],\r\n        });\r\n        return payload;\r\n    } catch (error) {\r\n        return null;\r\n    }\r\n}\r\n\r\n// --- Cookie Auth ---\r\nexport async function setCookieAuth(user: Omit<User, \"password\">) {\r\n    const expires = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours\r\n    const session = await encrypt({ user, expires });\r\n\r\n    const cookieStore = await cookies();\r\n    cookieStore.set(\"session\", session, {\r\n        expires,\r\n        httpOnly: true,\r\n        secure: process.env.NODE_ENV === \"production\",\r\n        sameSite: \"lax\",\r\n        path: \"/\",\r\n    });\r\n}\r\n\r\nexport async function clearCookieAuth() {\r\n    const cookieStore = await cookies();\r\n    cookieStore.set(\"session\", \"\", {\r\n        expires: new Date(0),\r\n        httpOnly: true,\r\n        secure: process.env.NODE_ENV === \"production\",\r\n        sameSite: \"lax\",\r\n        path: \"/\",\r\n    });\r\n}\r\n\r\nexport async function getSession() {\r\n    const cookieStore = await cookies();\r\n    const session = cookieStore.get(\"session\")?.value;\r\n    if (!session) return null;\r\n    return await decrypt(session);\r\n}\r\n\r\nexport async function getUserFromSession(): Promise<Omit<User, \"password\"> | null> {\r\n    const session = await getSession();\r\n    if (!session || !session.user) return null;\r\n\r\n    try {\r\n        const freshUser = await storage.getUser(session.user.id);\r\n        if (!freshUser || !freshUser.isActive) return null;\r\n        const { password, ...userWithoutPassword } = freshUser;\r\n        return userWithoutPassword;\r\n    } catch (err) {\r\n        return null;\r\n    }\r\n}\r\n\r\n// --- Password Hashing Setup ---\r\nconst scryptAsync = promisify(scrypt);\r\n\r\nexport async function hashedPassword(password: string) {\r\n    const salt = randomBytes(16).toString(\"hex\");\r\n    const buf = (await scryptAsync(password, salt, 64)) as Buffer;\r\n    return `${buf.toString(\"hex\")}.${salt}`;\r\n}\r\n\r\nexport async function comparePasswords(supplied: string, stored: string) {\r\n    const [hashed, salt] = stored.split(\".\");\r\n    const hashedBuf = Buffer.from(hashed, \"hex\");\r\n    const suppliedBuf = (await scryptAsync(supplied, salt, 64)) as Buffer;\r\n    return timingSafeEqual(hashedBuf, suppliedBuf);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AACA;AAEA;AACA;AACA;;;;;;;;;;AAEA,oBAAoB;AACpB,MAAM,YAAY,QAAQ,GAAG,CAAC,cAAc,IAAI;AAChD,MAAM,MAAM,IAAI,cAAc,MAAM,CAAC;AAE9B,eAAe,QAAQ,OAAY;IACtC,OAAO,MAAM,IAAI,0MAAO,CAAC,SACpB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,OAClB,IAAI,CAAC;AACd;AAEO,eAAe,QAAQ,KAAa;IACvC,IAAI;QACA,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,8MAAS,EAAC,OAAO,KAAK;YAC5C,YAAY;gBAAC;aAAQ;QACzB;QACA,OAAO;IACX,EAAE,OAAO,OAAO;QACZ,OAAO;IACX;AACJ;AAGO,eAAe,cAAc,IAA4B;IAC5D,MAAM,UAAU,IAAI,KAAK,KAAK,GAAG,KAAK,KAAK,KAAK,KAAK,OAAO,WAAW;IACvE,MAAM,UAAU,MAAM,QAAQ;QAAE;QAAM;IAAQ;IAE9C,MAAM,cAAc,MAAM,IAAA,+KAAO;IACjC,YAAY,GAAG,CAAC,WAAW,SAAS;QAChC;QACA,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,MAAM;IACV;AACJ;AAEO,eAAe;IAClB,MAAM,cAAc,MAAM,IAAA,+KAAO;IACjC,YAAY,GAAG,CAAC,WAAW,IAAI;QAC3B,SAAS,IAAI,KAAK;QAClB,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,MAAM;IACV;AACJ;AAEO,eAAe;IAClB,MAAM,cAAc,MAAM,IAAA,+KAAO;IACjC,MAAM,UAAU,YAAY,GAAG,CAAC,YAAY;IAC5C,IAAI,CAAC,SAAS,OAAO;IACrB,OAAO,MAAM,QAAQ;AACzB;AAEO,eAAe;IAClB,MAAM,UAAU,MAAM;IACtB,IAAI,CAAC,WAAW,CAAC,QAAQ,IAAI,EAAE,OAAO;IAEtC,IAAI;QACA,MAAM,YAAY,MAAM,qKAAO,CAAC,OAAO,CAAC,QAAQ,IAAI,CAAC,EAAE;QACvD,IAAI,CAAC,aAAa,CAAC,UAAU,QAAQ,EAAE,OAAO;QAC9C,MAAM,EAAE,QAAQ,EAAE,GAAG,qBAAqB,GAAG;QAC7C,OAAO;IACX,EAAE,OAAO,KAAK;QACV,OAAO;IACX;AACJ;AAEA,iCAAiC;AACjC,MAAM,cAAc,IAAA,8GAAS,EAAC,+GAAM;AAE7B,eAAe,eAAe,QAAgB;IACjD,MAAM,OAAO,IAAA,oHAAW,EAAC,IAAI,QAAQ,CAAC;IACtC,MAAM,MAAO,MAAM,YAAY,UAAU,MAAM;IAC/C,OAAO,GAAG,IAAI,QAAQ,CAAC,OAAO,CAAC,EAAE,MAAM;AAC3C;AAEO,eAAe,iBAAiB,QAAgB,EAAE,MAAc;IACnE,MAAM,CAAC,QAAQ,KAAK,GAAG,OAAO,KAAK,CAAC;IACpC,MAAM,YAAY,OAAO,IAAI,CAAC,QAAQ;IACtC,MAAM,cAAe,MAAM,YAAY,UAAU,MAAM;IACvD,OAAO,IAAA,wHAAe,EAAC,WAAW;AACtC"}},
    {"offset": {"line": 626, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jerry/Desktop/PROJECT%202026/POS/src/app/api/login/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { storage } from \"@/lib/storage\";\r\nimport { comparePasswords, setCookieAuth } from \"@/lib/auth\";\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        const { username, password } = await req.json();\r\n\r\n        const user = await storage.getUserByUsername(username);\r\n        if (!user || !(await comparePasswords(password, user.password))) {\r\n            return NextResponse.json(\r\n                { message: \"Invalid username or password\" },\r\n                { status: 401 }\r\n            );\r\n        }\r\n\r\n        if (!user.isActive) {\r\n            return NextResponse.json(\r\n                { message: \"Account is inactive\" },\r\n                { status: 403 }\r\n            );\r\n        }\r\n\r\n        const { password: _, ...safeUser } = user;\r\n\r\n        // Set the JWT cookie\r\n        await setCookieAuth(safeUser);\r\n\r\n        return NextResponse.json(safeUser);\r\n    } catch (error) {\r\n        console.error(\"Login error:\", error);\r\n        return NextResponse.json(\r\n            { message: \"Internal server error\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;;AAEO,eAAe,KAAK,GAAY;IACnC,IAAI;QACA,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAI,IAAI;QAE7C,MAAM,OAAO,MAAM,qKAAO,CAAC,iBAAiB,CAAC;QAC7C,IAAI,CAAC,QAAQ,CAAE,MAAM,IAAA,2KAAgB,EAAC,UAAU,KAAK,QAAQ,GAAI;YAC7D,OAAO,mLAAY,CAAC,IAAI,CACpB;gBAAE,SAAS;YAA+B,GAC1C;gBAAE,QAAQ;YAAI;QAEtB;QAEA,IAAI,CAAC,KAAK,QAAQ,EAAE;YAChB,OAAO,mLAAY,CAAC,IAAI,CACpB;gBAAE,SAAS;YAAsB,GACjC;gBAAE,QAAQ;YAAI;QAEtB;QAEA,MAAM,EAAE,UAAU,CAAC,EAAE,GAAG,UAAU,GAAG;QAErC,qBAAqB;QACrB,MAAM,IAAA,wKAAa,EAAC;QAEpB,OAAO,mLAAY,CAAC,IAAI,CAAC;IAC7B,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO,mLAAY,CAAC,IAAI,CACpB;YAAE,SAAS;QAAwB,GACnC;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}